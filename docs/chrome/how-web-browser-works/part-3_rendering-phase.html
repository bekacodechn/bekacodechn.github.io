<!DOCTYPE html>
  <html>
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <link rel="icon" href="" type="image/svg+xml"></link>
      <script  id="check-dark-light">
        ;(() => {
          const saved = localStorage.getItem('island-theme-appearance')
          const prefereDark = window.matchMedia('(prefers-color-scheme: dark)').matches
          if (!saved || saved === 'auto' ? prefereDark : saved === 'dark') {
            document.documentElement.classList.add('dark')
          }
        })()
      </script>
      <title data-rh="true">浏览器如何逐步工作 — 渲染阶段（第 3 部分）</title>
      <meta data-rh="true" name="description" content="Island"/>
      
      
      <script defer src='https://ga.jspm.io/npm:es-module-shims@1.6.0/dist/es-module-shims.js'></script>
      <script type="importmap">
        {
          "imports": {
            "react": "/react.js","react-dom": "/react-dom.js","react-dom/client": "/react-dom_client.js","react/jsx-runtime": "/react_jsx-runtime.js"
          }
        }
      </script>

      <link rel="stylesheet" href="/assets/style.81be0ec3.css">

    </head>
    <body>
      <div id="root"><div style="height:100%"><header relative="" z="4" fixed="md:~" class="top-0 left-0" w="100%"><div relative="" p="l-8 sm:x-8" transition="background-color duration-500" class="divider-bottom md:border-b-transparent lg:border-b-transparent" nav-h="mobile lg:desktop"><div flex="" justify="between" m="0 auto" nav-h="mobile lg:desktop" class="_container_1ic07_52  _has-sidebar_1ic07_16"><div border="border t-0 b-1 border-solid transparent" class="_nav-bar-title_1ic07_16"><a href="/" w="100%" h="100%" text="1rem" font="semibold" transition="opacity duration-300" hover="opacity-60" class="flex items-center"><span>beka的博客</span></a></div><div class="_content_1ic07_24" flex="~ 1" justify="end" items-center=""><div class="search" flex="sm:1" pl="sm:8"><div flex="" items-center="~" relative="" mr="2" font="semibold"><svg width="32" height="32" viewBox="0 0 32 32" w="5" h="5" fill="currentColor"><path fill="#888888" d="m29 27.586l-7.552-7.552a11.018 11.018 0 1 0-1.414 1.414L27.586 29ZM4 13a9 9 0 1 1 9 9a9.01 9.01 0 0 1-9-9Z"></path></svg><input disabled="" cursor="text focus:auto" placeholder="Search" height="8" border="none" type="text" text="sm" p="t-0 r-2 b-0 l-2" transition="all duration-200 ease" class="rounded-sm _searchInput_y03a3_1 " aria-label="Search" autoComplete="off"/><div m="r-3" w="10" h="6" p="x-1.5" rounded="md" border="1px solid gray-light-3" text="xs gray-light-3" flex="~" items-center="~" justify="around" class="_searchCommand_y03a3_7"><span>⌘</span><span>K</span></div></div></div><div class="_rightNav_1ic07_42"><div class="menu"><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Article</a></div><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Article-set</a></div><div text="sm" font="medium" m="x-3" class="text-brand"><a class="_link_r3fql_1 " target="" cursor="pointer">Chrome</a></div><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Design-pattern</a></div><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Open-source</a></div><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Promise</a></div><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Typescript</a></div><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Webpack</a></div></div><div class="appearance" before="menu-item-before" display="none sm:flex" items-center="center"><button class="_switch_1tqe3_1 undefined" id="" type="button" role="switch"><span class="_check_1tqe3_17"><span class="_icon_1tqe3_34"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="_sun_8e60k_1"><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="_moon_8e60k_5"><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg></span></span></button></div></div><button class=" _navHamburger_14nz8_1"><span class="_container_14nz8_14"><span class="_top_14nz8_21"></span><span class="_middle_14nz8_27"></span><span class="_bottom_14nz8_33"></span></span></button><div class="_navScreen_1mkpq_1 " id="navScreen"><div class="_container_1mkpq_21"><div class="_navMenu_1mkpq_27"><div w="100%" class="_navMenuItem_1mkpq_34"><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Article</a></div></div><div w="100%" class="_navMenuItem_1mkpq_34"><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Article-set</a></div></div><div w="100%" class="_navMenuItem_1mkpq_34"><div text="sm" font="medium" m="x-3" class="text-brand"><a class="_link_r3fql_1 " target="" cursor="pointer">Chrome</a></div></div><div w="100%" class="_navMenuItem_1mkpq_34"><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Design-pattern</a></div></div><div w="100%" class="_navMenuItem_1mkpq_34"><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Open-source</a></div></div><div w="100%" class="_navMenuItem_1mkpq_34"><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Promise</a></div></div><div w="100%" class="_navMenuItem_1mkpq_34"><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Typescript</a></div></div><div w="100%" class="_navMenuItem_1mkpq_34"><div text="sm" font="medium" m="x-3" class=""><a class="_link_r3fql_1 " target="" cursor="pointer">Webpack</a></div></div></div><div class="_socialAndAppearance_1mkpq_50" flex="~" justify="center" items-center="center"><div class="items-center appearance pa-2 _navAppearance_1mkpq_46" flex="~" justify="center"><button class="_switch_1tqe3_1 undefined" id="" type="button" role="switch"><span class="_check_1tqe3_17"><span class="_icon_1tqe3_34"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="_sun_8e60k_1"><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="_moon_8e60k_5"><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg></span></span></button></div></div></div></div></div></div></div></header><section style="padding-top:var(--island-nav-height)"><div p="t-0 x-6 b-24 sm:6" class="_docLayout_5cssi_8"><div class="_localNav_ncerp_1"><button flex="center" class="_menu_ncerp_16"><div text="md" mr="2" class="i-carbon:menu"></div><span text="md ">Menu</span></button></div><aside class="_sidebar_iav29_1 "><nav><section block="~" not-first="divider-top mt-4"><div flex="~" justify="between" items-start="~" class="items-center"><h2 m="t-3 b-2" text="1rem text-1" font="bold">Chrome</h2><div class="i-carbon-chevron-right" cursor-pointer="~" style="transition:transform 0.2s ease-out;transform:rotate(90deg)"></div></div><div mb="1.4 sm:1" style="transition:height 0.2s ease-out;height:28px;overflow:hidden"><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">以用户为中心的效果指标</a></div></div></div></div></section><section block="~" not-first="divider-top mt-4"><div flex="~" justify="between" items-start="~" class="items-center"><h2 m="t-3 b-2" text="1rem text-1" font="bold">浏览器工作原理</h2><div class="i-carbon-chevron-right" cursor-pointer="~" style="transition:transform 0.2s ease-out;transform:rotate(90deg)"></div></div><div mb="1.4 sm:1" style="transition:height 0.2s ease-out;height:168px;overflow:hidden"><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">Web 浏览器如何逐步工作 — 高级体系结构（第 1 部分）</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">Web 浏览器如何逐步工作 — 导航阶段（第 2 部分）</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-brand"><a class="_link_r3fql_1 " target="" cursor="pointer">浏览器如何逐步工作 — 渲染阶段（第 3 部分）</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">浏览器如何逐步工作 — 加载阶段的优化（第 4 部分）</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">浏览器如何一步一步地工作 — 交互阶段的优化（第 5 部分）</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">什么强制了重排/回流</a></div></div></div></div></section><section block="~" not-first="divider-top mt-4"><div flex="~" justify="between" items-start="~" class="items-center"><h2 m="t-3 b-2" text="1rem text-1" font="bold">Html</h2><div class="i-carbon-chevron-right" cursor-pointer="~" style="transition:transform 0.2s ease-out;transform:rotate(90deg)"></div></div><div mb="1.4 sm:1" style="transition:height 0.2s ease-out;height:84px;overflow:hidden"><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">Metadata</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">html</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer"># 文档结构</a></div></div></div></div></section><section block="~" not-first="divider-top mt-4"><div flex="~" justify="between" items-start="~" class="items-center"><h2 m="t-3 b-2" text="1rem text-1" font="bold">关键指标</h2><div class="i-carbon-chevron-right" cursor-pointer="~" style="transition:transform 0.2s ease-out;transform:rotate(90deg)"></div></div><div mb="1.4 sm:1" style="transition:height 0.2s ease-out;height:84px;overflow:hidden"><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">First Contentful Paint (FCP) 首次内容绘制</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">Largest Contentful Paint (LCP) 最大内容填充</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">Time to First Byte (TTFB) 首次字节加载时间</a></div></div></div></div></section><section block="~" not-first="divider-top mt-4"><div flex="~" justify="between" items-start="~" class="items-center"><h2 m="t-3 b-2" text="1rem text-1" font="bold">现代网络浏览器内幕</h2><div class="i-carbon-chevron-right" cursor-pointer="~" style="transition:transform 0.2s ease-out;transform:rotate(90deg)"></div></div><div mb="1.4 sm:1" style="transition:height 0.2s ease-out;height:112px;overflow:hidden"><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">现代网络浏览器内幕 — 1</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">现代网络浏览器内幕 — 2</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">现代网络浏览器内幕 — 3</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">现代网络浏览器内幕 — 4</a></div></div></div></div></section><section block="~" not-first="divider-top mt-4"><div flex="~" justify="between" items-start="~" class="items-center"><h2 m="t-3 b-2" text="1rem text-1" font="bold">性能</h2><div class="i-carbon-chevron-right" cursor-pointer="~" style="transition:transform 0.2s ease-out;transform:rotate(90deg)"></div></div><div mb="1.4 sm:1" style="transition:height 0.2s ease-out;height:224px;overflow:hidden"><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">1. Welcome to Lean performance</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">2. 一般 HTML 性能注意事项</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">使用导航定时和资源定时评估现场的负载性能</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">优化长任务</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">optimize-resource-loading 优化资源负载</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">通过摇树减少 JavaScript 有效负载</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">asdf</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">速度为什么重要</a></div></div></div></div></section><section block="~" not-first="divider-top mt-4"><div flex="~" justify="between" items-start="~" class="items-center"><h2 m="t-3 b-2" text="1rem text-1" font="bold">性能技巧</h2><div class="i-carbon-chevron-right" cursor-pointer="~" style="transition:transform 0.2s ease-out;transform:rotate(90deg)"></div></div><div mb="1.4 sm:1" style="transition:height 0.2s ease-out;height:476px;overflow:hidden"><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">Web 上的多进程：浏览器进程模型</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">Browser Rendering Pipeline</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">通过火焰图找到有问题的代码</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">如何收集 Web 性能跟踪</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">事件循环基础知识</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">深度讲解火焰图 🔥🔥</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">长任务：它们是什么以及为什么应该避免它们</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">performance 查看主线程（颜色含义）</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">检测浏览器何时在 JavaScript 中绘制Frame</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">如何阅读 Chromium Profiler</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">使用 Chromium 网络标签页获取性能详情</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">使用性能时序标记进行📏测量</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">Chromium F12 性能分析器的基本概述</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">【--空文件--】: performance/tips/resource-size-vs-transfer-size.md</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">如何阅读火焰图 🔥</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">识别 Web 应用中的未压缩资源</a></div></div></div><div><div style="margin-left:0px"><div p="1" block="~" text="sm" font-medium="~" class="text-text-2"><a class="_link_r3fql_1 " target="" cursor="pointer">asdfadsasdsdfasdf</a></div></div></div></div></section></nav></aside><div flex="~ 1 shrink-0" m="x-auto" class="_content_5cssi_2"><div m="x-auto" flex="~ col" class="max-w-100%"><div relative="~" m="x-auto" p="l-2" class="w-100% md:max-w-712px lg:min-w-640px "><div class="island-doc "><!--$--><h1 id="浏览器如何逐步工作--渲染阶段第-3-部分"><a class="header-anchor" aria-hidden="true" href="#浏览器如何逐步工作--渲染阶段第-3-部分">#</a>浏览器如何逐步工作 — 渲染阶段（第 3 部分）</h1>
<p><code>metadata:</code></p>
<p><strong>原标题:</strong> How does browser work step by step [latest] — rendering phase (part 3)</p>
<p><strong>链接:</strong> <a href="https://cabulous.medium.com/how-does-browser-work-in-2019-part-iii-rendering-phase-i-850c8935958f" target="_blank" rel="nofollow">https://cabulous.medium.com/how-does-browser-work-in-2019-part-iii-rendering-phase-i-850c8935958f</a></p>
<hr/>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108180639.png" alt="20231108180639"/></p>
<p>在上一篇文章中，我们看到了导航阶段。三个流程协同工作，为下一阶段交付文档。</p>
<p>在这篇文章中，我们将打开渲染阶段的盒子，看看里面有什么。</p>
<h2 id="from-document-to-web-page--8-sub-phases-从文档到网页--8-个子阶段"><a class="header-anchor" aria-hidden="true" href="#from-document-to-web-page--8-sub-phases-从文档到网页--8-个子阶段">#</a>From document to web page — 8 sub-phases 从文档到网页 — 8 个子阶段</h2>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108180816.png" alt="20231108180816"/></p>
<p>渲染阶段包括 8 个子阶段：</p>
<ol>
<li>DOM construction <strong>DOM 构造</strong></li>
<li>Style computation 样式计算</li>
<li>Layout 布局</li>
<li>Layer 层</li>
<li>Paint 绘制</li>
<li>Tilling 耕作</li>
<li>Raster 网 格</li>
<li>Draw Quad and display 绘制四边形并显示</li>
</ol>
<p>渲染器进程中的两个线程涉及：</p>
<ul>
<li>主线程负责 1-5 个阶段</li>
<li>合成器线程管理 6-8 个阶段</li>
</ul>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108181205.png" alt="20231108181205"/></p>
<h2 id="phase-1-dom-construction-第-1-阶段dom-构建"><a class="header-anchor" aria-hidden="true" href="#phase-1-dom-construction-第-1-阶段dom-构建">#</a>Phase 1: DOM construction 第 1 阶段：DOM 构建</h2>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108181234.png" alt="20231108181234"/></p>
<p>输入是网络进程中的 HTML 文档，输出是 DOM 树。</p>
<p>为什么要使用 DOM 树？浏览器不会说 HTML。渲染过程首先需要将 HTML 文档 &quot;翻译 &quot;成浏览器可以理解的内容。</p>
<p>这就是 DOM 树。</p>
<p>让我们看一个例子。</p>
<div class="language-html line-numbers-mode" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">html</span><pre><code class=""><span class="line"><span style="color:#81A1C1">&lt;html&gt;</span></span>
<span class="line"><span style="color:#81A1C1">&lt;body&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">   </span><span style="color:#81A1C1">&lt;h1&gt;</span><span style="color:#D8DEE9FF">Hello world!</span><span style="color:#81A1C1">&lt;/h1&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">   </span><span style="color:#81A1C1">&lt;div&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">       </span><span style="color:#81A1C1">&lt;p&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">           It is a message from</span></span>
<span class="line"><span style="color:#D8DEE9FF">           </span><span style="color:#81A1C1">&lt;span&gt;</span><span style="color:#D8DEE9FF">the web</span><span style="color:#81A1C1">&lt;/span&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">       </span><span style="color:#81A1C1">&lt;/p&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">   </span><span style="color:#81A1C1">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#81A1C1">&lt;/body&gt;</span></span>
<span class="line"><span style="color:#81A1C1">&lt;/html&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><span class="line-number">2</span><span class="line-number">3</span><span class="line-number">4</span><span class="line-number">5</span><span class="line-number">6</span><span class="line-number">7</span><span class="line-number">8</span><span class="line-number">9</span><span class="line-number">10</span><span class="line-number">11</span></div></div>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108181419.png" alt="20231108181419"/></p>
<p>该示例的DOM树如图所示。</p>
<p>DOM 树是 HTML 代码的表示形式。我们可以通过在 Chrome 浏览器控制台中输入 &quot;document &quot;来访问它。</p>
<p>DOM 树存在于内存中。因此，JavaScript 可以访问和编辑它。</p>
<h2 id="phase-2-style-computation-第-2-阶段样式计算"><a class="header-anchor" aria-hidden="true" href="#phase-2-style-computation-第-2-阶段样式计算">#</a>Phase 2: Style computation 第 2 阶段：样式计算</h2>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108181607.png" alt="20231108181607"/></p>
<p>输入是 CSS 样式，输出是计算后的样式结构。</p>
<p>它有三个步骤。</p>
<h3 id="step-1-translating-css-第-1-步翻译css"><a class="header-anchor" aria-hidden="true" href="#step-1-translating-css-第-1-步翻译css">#</a>Step 1: “Translating” CSS 第 1 步：“翻译”CSS</h3>
<p>与 HTML 相似，浏览器不会说 CSS。翻译的结果就是样式表。</p>
<p>在 Chrome 浏览器控制台中输入 &quot;document.styleSheets&quot;，我们就能看到所有已解析的样式表。</p>
<p>这些样式表来自</p>
<ul>
<li>a source linked in the <!-- --> tag, (在 <code>&lt;link&gt;</code> 标记中链接的源代码、)</li>
<li>styles inside of a <!-- -->, and (内的样式，以及)</li>
<li>inline styles (内联样式)</li>
</ul>
<p>与 DOM 树一样，样式表看起来像 JavaScript 对象结构，可以在内存中访问和编辑。</p>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108182010.png" alt="20231108182010"/></p>
<p>以 Medium 主页为例。它有 11 个样式表。第一个来自 <code>&lt;link&gt;</code> 标签，其余的都是 <code>&lt;style&gt;</code> 标签内的样式。</p>
<h3 id="step-2-standardizing-values-and-unites-步骤-2统一价值观和统一标准"><a class="header-anchor" aria-hidden="true" href="#step-2-standardizing-values-and-unites-步骤-2统一价值观和统一标准">#</a>Step 2: standardizing values and unites 步骤 2：统一价值观和统一标准</h3>
<p>我们在 CSS 中使用各种数值和单位。</p>
<ul>
<li>宽度： 50%</li>
<li>padding：2em 0</li>
<li>font-size: 1rem</li>
</ul>
<p>它们是相对值。</p>
<p>在这一步，所有相对值都会转换为绝对值，即像素。</p>
<p>为什么是像素？在渲染阶段结束时，浏览器会在屏幕上显示位图。位图由像素组成。</p>
<p>现在是计算的时候了。</p>
<p>在标准化结束时，先前的 CSS 值将变为以下值：</p>
<ul>
<li>width: 500px（假设其父元素的宽度为 1000px。）</li>
<li>padding：32px 0（假设元素的字体大小为 16px。）</li>
<li>font-size: 16px（假设根元素的字体大小为 16px。）</li>
</ul>
<h3 id="step-3-style-computation-步骤-3样式计算"><a class="header-anchor" aria-hidden="true" href="#step-3-style-computation-步骤-3样式计算">#</a>Step 3: style computation 步骤 3：样式计算</h3>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108182642.png" alt="20231108182642"/></p>
<p>最后，渲染器程序会计算所计算的样式，并将其附加到每个元素上。</p>
<p>为什么要计算样式？CSS 是层叠样式表的缩写。层叠是指元素从其祖先那里继承一些样式，并用自己的样式覆盖其中的一部分。</p>
<p>渲染器程序会根据层叠规则计算所有样式。然后，它会为每个元素生成一个最终计算样式的列表。</p>
<p>例如，一个元素从其祖先那里继承了 font-size: 16px。其自身的字体大小为 32px。计算出的字体大小样式就是 font-size: 32px。</p>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108182859.png" alt="20231108182859"/></p>
<p>图片显示的是 Medium 主页上 h2 元素的计算样式列表。</p>
<p>计算完成后，最终结果是一个计算样式列表。我们可以在 Chrome 浏览器控制台中查看。</p>
<h2 id="phase-3-layout-布局"><a class="header-anchor" aria-hidden="true" href="#phase-3-layout-布局">#</a>Phase 3: Layout 布局</h2>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108183005.png" alt="20231108183005"/></p>
<p>在此阶段，输入是 DOM 树和计算出的样式。输出则是包含计算布局信息的布局树。</p>
<h3 id="step-1-constructing-the-layout-tree-步骤-1构建布局树"><a class="header-anchor" aria-hidden="true" href="#step-1-constructing-the-layout-tree-步骤-1构建布局树">#</a>Step 1: constructing the layout tree 步骤 1：构建布局树</h3>
<p>布局树看起来就像 DOM 树的复制品。</p>
<p>有哪些不同之处呢？首先，DOM 树中的 &quot;不可见 &quot;元素不会包含在布局树中。</p>
<p>例如，布局树中不会包含 display: none 的元素。这与 <code>&lt;header&gt;</code> 标签内的所有元素一样。但有一个例外：在布局树中包含 visibility: hidden; 的元素。</p>
<p>其次，某些 CSS 属性会将内容添加到布局中。</p>
<p>以伪类为例，<code>div::after {content：&#x27;我在这里&#x27;;}</code>会创建一个包含在布局树中的内容，尽管它并不存在于 DOM 树中。</p>
<h3 id="step-2-calculating-the-geometry-information-步骤-2计算几何体信息"><a class="header-anchor" aria-hidden="true" href="#step-2-calculating-the-geometry-information-步骤-2计算几何体信息">#</a>Step 2: calculating the geometry information 步骤 2：计算几何体信息</h3>
<p>要在空白的画布上画出一个盒子，我们需要知道：</p>
<ul>
<li>起始 x、y 坐标，以及</li>
<li>方框的大小</li>
</ul>
<p>布局树中的每个元素都是一个方框。</p>
<p>计算每个元素的最终几何形状是一项艰巨的工作。想一想吧。在 CSS 中，有许多属性可以修改元素的几何形状。</p>
<ul>
<li>float: left；</li>
<li>宽度： 100px；</li>
<li>display: absolute；</li>
<li>以及更多...</li>
</ul>
<p>要设计一个有效的布局系统与之配合使用，是一项具有挑战性的工作。<a href="https://www.youtube.com/watch?v=Y5Xa4H2wtVA" target="_blank" rel="nofollow">BlinkOn 的开发人员与我们分享了一些知识</a>，如果你感兴趣的话。</p>
<p>主线程为我们完成了繁重的工作，并完成了所有计算。</p>
<p>现在，它有了一个布局树。在布局树上，每个元素都有精确的坐标和尺寸信息。</p>
<h2 id="phase-4-layer-图层"><a class="header-anchor" aria-hidden="true" href="#phase-4-layer-图层">#</a>Phase 4: Layer 图层</h2>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108184128.png" alt="20231108184128"/></p>
<p>输入是布局树，输出是图层树。</p>
<p>第三层是关于层的。</p>
<p>我们都喜欢 CSS 中的 3D 变换效果和方便的 <code>z-index</code> 属性。它们都与层有关。</p>
<p>如果你用过 Photoshop 或 Sketch，你一定会对图层很熟悉。浏览器中的层也有同样的概念。</p>
<p>而图层树则与绘制顺序有关。我们为什么要关心绘制顺序？</p>
<p>例如，有两个重叠的元素，元素 A 和元素 B。A 的 <code>z-index</code>是 9，比没有 z-index 属性的 B 更重要。渲染器会先在画布上绘制 B，然后再在其上绘制 A。这是一种绘制顺序。</p>
<p>绘制顺序对于准确显示网页至关重要。</p>
<p>图层树是怎样的？</p>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108184419.png" alt="20231108184419"/></p>
<p><strong>从图中我们可以看到，并非所有元素都有自己的图层。绘制图层的成本很高。为了提高性能，渲染器进程只在需要时才创建图层。</strong></p>
<p>何时需要？渲染器进程会考虑两种元素。</p>
<h3 id="具有堆叠上下文的元素"><a class="header-anchor" aria-hidden="true" href="#具有堆叠上下文的元素">#</a>具有堆叠上下文的元素</h3>
<ul>
<li>z-index</li>
<li>position: absolute</li>
<li>transform</li>
<li>will-change</li>
</ul>
<p>以上是一些与堆叠上下文相关的 CSS 属性。渲染器处理过程会为具有这些属性的元素创建一个层。</p>
<p>你可以在 <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context" target="_blank" rel="nofollow">MDN 文档</a>中查看影响层树的 CSS 属性的完整列表。</p>
<p>Chrome 浏览器允许我们查看网页上的层。</p>
<h3 id="剪切元素"><a class="header-anchor" aria-hidden="true" href="#剪切元素">#</a>剪切元素</h3>
<p>溢出文本元素是剪切元素的典型案例。</p>
<p>假设我们有一个 300px * 300px 的 div。div 框中的长文本会溢出。在给方框设置 <code>overflow: auto;</code> 时，我们知道文字在 div 中可以滚动。</p>
<p>当看到溢出的文本元素时，渲染器会创建三个层。</p>
<ul>
<li>一个用于剪切文本，在 300px * 300px 区域内可见。</li>
<li>一个用于显示全文内容，以便滚动浏览。</li>
<li>一个用于滚动条</li>
</ul>
<p>在控制台中查看更容易理解这种机制。</p>
<p>在 Chrome 浏览器中运行以下 HTML。</p>
<div class="language-html line-numbers-mode" style="background-color:#2e3440ff"><button class="copy"></button><span class="lang">html</span><pre><code class=""><span class="line"><span style="color:#81A1C1">&lt;html&gt;</span></span>
<span class="line"><span style="color:#81A1C1">&lt;body&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">&lt;h1&gt;</span><span style="color:#D8DEE9FF">Hell world!</span><span style="color:#81A1C1">&lt;/h1&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">&lt;div</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">class</span><span style="color:#ECEFF4">=</span><span style="color:#A3BE8C">“box”</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">style</span><span style="color:#ECEFF4">=</span><span style="color:#A3BE8C">“width:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">300px;</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">height:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">300px;</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">overflow:</span><span style="color:#D8DEE9FF"> </span><span style="color:#8FBCBB">auto;”</span><span style="color:#81A1C1">&gt;</span></span>
<span class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">&lt;p&gt;</span><span style="color:#D8DEE9FF">Lorem ipsum vel viverra elementum ut et parturient placerat curae at vestibulum ullamcorper a ullamcorper mattis nascetur ullamcorper ut mollis rhoncus sed parturient in vestibulum vestibulum. Leo nec nisi nec erat a purus aliquam habitasse a sem id nisi ullamcorper viverra suspendisse mollis fringilla a dis a suspendisse parturient a. A commodo scelerisque mi dictum non orci suspendisse felis velit dapibus a sit facilisis velit mi libero ultrices leo consectetur tempus montes quis consequat condimentum a ullamcorper amet. Donec orci fames id consectetur nascetur parturient et magnis nunc lacinia aliquet nec dolor dictumst conubia a hac nibh consectetur habitant vel a cras.</span><span style="color:#81A1C1">&lt;/p&gt;</span></span>
<span class="line"><span style="color:#81A1C1">&lt;/div&gt;</span></span>
<span class="line"><span style="color:#81A1C1">&lt;/body&gt;</span></span>
<span class="line"><span style="color:#81A1C1">&lt;/html&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><span class="line-number">2</span><span class="line-number">3</span><span class="line-number">4</span><span class="line-number">5</span><span class="line-number">6</span><span class="line-number">7</span><span class="line-number">8</span></div></div>
<p>打开图层面板看一看。图层显示在图层面板中。尝试滚动框中的文字，你就会明白了。</p>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108185209.png" alt="20231108185209"/></p>
<p>但实践中，只有 1. 一个用于显示全文内容，以便滚动浏览。  2. 一个用于滚动条。 左侧列表也只有3个item，比文中给出的示例少一个。
<img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108190307.png" alt="20231108190307"/></p>
<p>最后，在完成所有计算后，渲染器进程就可以得到图层树了。</p>
<h2 id="phase-5-paint-绘制"><a class="header-anchor" aria-hidden="true" href="#phase-5-paint-绘制">#</a>Phase 5: Paint 绘制</h2>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108190755.png" alt="20231108190755"/></p>
<p>在这一阶段，输入是布局树和图层树，输出是 paint record.</p>
<p>paint record 是什么样的？</p>
<p>它由三部分组成：</p>
<ul>
<li>Action</li>
<li>Position, including the coordinates (x, y) and the size (width, height). 位置，包括坐标（x、y）和尺寸（宽、高）。</li>
<li>Styles</li>
</ul>
<p>For example, a paint record looks like the following:</p>
<ul>
<li>Action: Draw Rect</li>
<li>Pos: 0, 0, 300, 300</li>
<li>backgroundColor: red</li>
</ul>
<p>这是一条在（0，0）处绘制 300px * 300px 红色矩形的绘画记录。</p>
<p>绘制记录就像浏览器执行绘制的注释。</p>
<p>绘画记录是这些注释的列表，按照我们在图层树中确认的顺序排列，比如 &quot;先背景，后矩形，再文本&quot;。</p>
<p>在下一步中，合成器线程将继承主线程的工作，开始根据绘画记录生成位图。</p>
<h2 id="phase-6-tilling-耕作"><a class="header-anchor" aria-hidden="true" href="#phase-6-tilling-耕作">#</a>Phase 6: Tilling 耕作？？？</h2>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108192332.png" alt="20231108192332"/></p>
<p>平铺时，图层被分成图块，浏览器根据视口位置优先渲染。</p>
<p>这里有三个关键字：图层、图块和视口。</p>
<p>让我们以 Medium 主页为例。从 DevTools 的图层面板中，我们可以看到它有三个图层：</p>
<ul>
<li>document</li>
<li>header</li>
<li>scroll bar</li>
</ul>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108192510.png" alt="20231108192510"/></p>
<p>“文档”层被分成图块。通常，图块大小为256px<em>256px或512px</em>512px。</p>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108192638.png" alt="20231108192638"/></p>
<p>渲染所有图块都很昂贵。当前在视口中的可见图块具有优先级。</p>
<h2 id="phase-7-raster-第7阶段光栅"><a class="header-anchor" aria-hidden="true" href="#phase-7-raster-第7阶段光栅">#</a>Phase 7: Raster 第7阶段：光栅</h2>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108192718.png" alt="20231108192718"/></p>
<p>输入是图块，输出是位图。</p>
<p>了解图块后，合成器线程创建一个光栅线程池。多个光栅线程同时进行光栅图块。</p>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108192825.png" alt="20231108192825"/></p>
<p>为了加快进程，光栅线程通过 IPC 向 GPU 进程发送图块。然后，GPU 进程根据图块生成位图，并将位图保存在 GPU 内存中。</p>
<p>位图准备就绪后，GPU 进程会将其传送回渲染进程中的合成线程，以便进行下一步处理。</p>
<h2 id="phase-8-draw-quad-and-display--第-8-阶段-绘制四边形并显示"><a class="header-anchor" aria-hidden="true" href="#phase-8-draw-quad-and-display--第-8-阶段-绘制四边形并显示">#</a>Phase 8: Draw Quad and Display  第 8 阶段： 绘制四边形并显示</h2>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108193018.png" alt="20231108193018"/></p>
<p>输入是位图，输出是合成帧。</p>
<p>当所有需要的位图都处理完毕后，合成器线程会向浏览器进程发送一条名为 &quot;绘制四边形 &quot;的命令。</p>
<p>在浏览器进程内部，“viz”组件接收Draw Quad命令，执行Display Compositor命令，并将合成器帧“绘制”到我们的计算机内存中。</p>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108193213.png" alt="20231108193213"/></p>
<p>最后，浏览器进程在浏览器中显示合成器帧(compositor frame)。</p>
<p>令人印象深刻的是，在现代浏览器中，整个8个阶段都在1/60秒内发生。也就是16.67毫秒。</p>
<h2 id="what-is-the-takeaway-有什么启示"><a class="header-anchor" aria-hidden="true" href="#what-is-the-takeaway-有什么启示">#</a>What is the takeaway? 有什么启示？</h2>
<p><img src="https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108193347.png" alt="20231108193347"/></p>
<p>渲染的8个阶段：</p>
<ol>
<li>The main thread in the renderer process “translates” the HTML document to <strong>DOM tree</strong></li>
<li>It conveys(传送) CSS into the <strong>computed style</strong></li>
<li>It creates a <strong>layout tree</strong> based on the DOM tree and computed style</li>
<li>From a layout tree, it generates a <strong>layer tree</strong></li>
<li>Lastly, it establishes <strong>paint records</strong></li>
<li>The compositor thread(合成线程) carries over the paint records, starts <strong>tilling</strong> based on the current viewport</li>
<li>Multiple raster threads <strong>raster</strong> tiles into bitmaps with the help of the GPU process.</li>
<li>The browser process receives the <strong>Draw Quad</strong> command from the browser process, then it displays a frame of the page in front of us.</li>
</ol>
<h2 id="2019-年渲染树不再重要"><a class="header-anchor" aria-hidden="true" href="#2019-年渲染树不再重要">#</a>2019 年，渲染树不再重要</h2>
<p>如果你听说过 &quot;渲染树&quot;，那么它在 2019 年已不再适用。类似的概念还有图层树。</p>
<div class="island-directive danger"><p class="island-directive-title">DANGER</p><div class="island-directive-content"><p>原文：</p><h2 id="render-tree-is-not-relevant-in-2019"><a class="header-anchor" aria-hidden="true" href="#render-tree-is-not-relevant-in-2019">#</a>Render tree is not relevant in 2019</h2><p>If you heard of render tree, it is not relevant anymore in 2019. A similar concept here is the layer tree.</p><p>为什么说不适用？</p></div></div>
<h2 id="references"><a class="header-anchor" aria-hidden="true" href="#references">#</a>References</h2>
<ul>
<li><a href="https://developers.google.com/web/updates/2018/09/inside-browser-part3" target="_blank" rel="nofollow">Inside look at modern web browser (part 3) | Google Developers</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index" target="_blank" rel="nofollow">Understanding CSS z-index — CSS: Cascading Style Sheets | MDN</a></li>
</ul><!--/$--></div><footer mt="8"><div class="xs:flex" p="b-5" justify="between" items-center="~"><div flex="" text="sm text-2" leading-6="~" leading-8="sm:~" font-medium=""><p>Last Updated: </p><span>2023/11/9 01:52:20</span></div></div><div flex="~ col sm:row" justify="sm:around" gap="2" divider-top="" pt="6"><div flex="~ col" class="_prev_1f77m_13"><a href="/chrome/how-web-browser-works/part-2_navigation-phase" class="_pager-link_1f77m_20"><span class="_desc_1f77m_43">Previous Page</span><span class="_title_1f77m_34">Web 浏览器如何逐步工作 — 导航阶段（第 2 部分）</span></a></div><div flex="~ col" class="_next_1f77m_16"><a href="/chrome/how-web-browser-works/part-4_optimization-in-the-loading-stage" class="_pager-link_1f77m_20 _next_1f77m_16"><span class="_desc_1f77m_43">Next page</span><span class="_title_1f77m_34">浏览器如何逐步工作 — 加载阶段的优化（第 4 部分）</span></a></div></div></footer></div></div><div relative="~" display="none lg:block" order="2" flex="1" p="l-8" class="max-w-256px"><div class="_aside-container_5cssi_32"><div flex="~ col" p="b-8" style="min-height:calc(100vh - (var(--island-nav-height-desktop) + 32px))"><div><div flex="~ col 1"><div display="lg:block"><div relative="" divider-left="" p="l-4" text="13px" font-medium="" id="aside-container"><div absolute="" pos="top-33px" opacity="0" w="1px" h="18px" bg="brand" style="left:-1px;transition:top 0.25s cubic-bezier(0, 1, 0.5, 1), background-color 0.5s, opacity 0.25s" id="aside-marker"></div><div block="~" leading-7="" text="13px" font="semibold">目录</div><nav><ul relative=""><li><a href="#from-document-to-web-page--8-sub-phases-从文档到网页--8-个子阶段" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">From document to web page — 8 sub-phases 从文档到网页 — 8 个子阶段</a></li><li><a href="#phase-1-dom-construction-第-1-阶段dom-构建" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">Phase 1: DOM construction 第 1 阶段：DOM 构建</a></li><li><a href="#phase-2-style-computation-第-2-阶段样式计算" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">Phase 2: Style computation 第 2 阶段：样式计算</a></li><li><a href="#step-1-translating-css-第-1-步翻译css" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">Step 1: “Translating” CSS 第 1 步：“翻译”CSS</a></li><li><a href="#step-2-standardizing-values-and-unites-步骤-2统一价值观和统一标准" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">Step 2: standardizing values and unites 步骤 2：统一价值观和统一标准</a></li><li><a href="#step-3-style-computation-步骤-3样式计算" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">Step 3: style computation 步骤 3：样式计算</a></li><li><a href="#phase-3-layout-布局" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">Phase 3: Layout 布局</a></li><li><a href="#step-1-constructing-the-layout-tree-步骤-1构建布局树" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">Step 1: constructing the layout tree 步骤 1：构建布局树</a></li><li><a href="#step-2-calculating-the-geometry-information-步骤-2计算几何体信息" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">Step 2: calculating the geometry information 步骤 2：计算几何体信息</a></li><li><a href="#phase-4-layer-图层" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">Phase 4: Layer 图层</a></li><li><a href="#具有堆叠上下文的元素" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">具有堆叠上下文的元素</a></li><li><a href="#剪切元素" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:12px">剪切元素</a></li><li><a href="#phase-5-paint-绘制" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">Phase 5: Paint 绘制</a></li><li><a href="#phase-6-tilling-耕作" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">Phase 6: Tilling 耕作？？？</a></li><li><a href="#phase-7-raster-第7阶段光栅" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">Phase 7: Raster 第7阶段：光栅</a></li><li><a href="#phase-8-draw-quad-and-display--第-8-阶段-绘制四边形并显示" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">Phase 8: Draw Quad and Display  第 8 阶段： 绘制四边形并显示</a></li><li><a href="#what-is-the-takeaway-有什么启示" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">What is the takeaway? 有什么启示？</a></li><li><a href="#2019-年渲染树不再重要" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">2019 年，渲染树不再重要</a></li><li><a href="#references" block="" leading-7="" text="text-2" avoid-text-overflow="" hover="text-text-1" transition="color duration-300" style="padding-left:0">References</a></li></ul></nav></div></div></div></div></div></div></div></div></div></section></div></div>
      <script>window.ISLAND_PAGE_DATA={"siteData":{"lang":"en-US","title":"beka的博客","description":"Island","themeConfig":{"lastUpdatedText":"上次更新","outlineTitle":"目录","nav":[{"text":"Article","link":"/article/astro","activeMatch":"/article/"},{"text":"Article-set","link":"/article-set/URL-SET","activeMatch":"/article-set/"},{"text":"Chrome","link":"/chrome/fast-load-time/user-centric-performance-metrics","activeMatch":"/chrome/"},{"text":"Design-pattern","link":"/design-pattern/indexs","activeMatch":"/design-pattern/"},{"text":"Open-source","link":"/open-source/delay","activeMatch":"/open-source/"},{"text":"Promise","link":"/promise/first-resolved","activeMatch":"/promise/"},{"text":"Typescript","link":"/typescript/tip","activeMatch":"/typescript/"},{"text":"Webpack","link":"/webpack/build-result","activeMatch":"/webpack/"}],"sidebar":{"article":[{"text":"Article","items":[{"text":"Astro","link":"/article/astro"},{"text":"新一代全栈框架 Fresh","link":"/article/fresh"}],"collapsable":true}],"article-set":[{"text":"Article-set","items":[{"text":"外链合集","link":"/article-set/URL-SET"},{"text":"requestAnimationFrame","link":"/article-set/raf"}],"collapsable":true}],"chrome":[{"text":"Chrome","items":[{"text":"以用户为中心的效果指标","link":"/chrome/fast-load-time/user-centric-performance-metrics"}],"collapsable":true},{"text":"浏览器工作原理","items":[{"text":"Web 浏览器如何逐步工作 — 高级体系结构（第 1 部分）","link":"/chrome/how-web-browser-works/part-1_high-level-architecture"},{"text":"Web 浏览器如何逐步工作 — 导航阶段（第 2 部分）","link":"/chrome/how-web-browser-works/part-2_navigation-phase"},{"text":"浏览器如何逐步工作 — 渲染阶段（第 3 部分）","link":"/chrome/how-web-browser-works/part-3_rendering-phase"},{"text":"浏览器如何逐步工作 — 加载阶段的优化（第 4 部分）","link":"/chrome/how-web-browser-works/part-4_optimization-in-the-loading-stage"},{"text":"浏览器如何一步一步地工作 — 交互阶段的优化（第 5 部分）","link":"/chrome/how-web-browser-works/part-5_optimization-in-the-interaction-stage"},{"text":"什么强制了重排/回流","link":"/chrome/how-web-browser-works/what-forces-layout-reflow"}],"collapsable":true},{"text":"Html","items":[{"text":"Metadata","link":"/chrome/html/metadata"},{"text":"html","link":"/chrome/html/overview"},{"text":"# 文档结构","link":"/chrome/html/structure"}],"collapsable":true},{"text":"关键指标","items":[{"text":"First Contentful Paint (FCP) 首次内容绘制","link":"/chrome/metrics/FCP"},{"text":"Largest Contentful Paint (LCP) 最大内容填充","link":"/chrome/metrics/LCP"},{"text":"Time to First Byte (TTFB) 首次字节加载时间","link":"/chrome/metrics/TTFB"}],"collapsable":true},{"text":"现代网络浏览器内幕","items":[{"text":"现代网络浏览器内幕 — 1","link":"/chrome/modern-web-browser/inside-browser-part-1"},{"text":"现代网络浏览器内幕 — 2","link":"/chrome/modern-web-browser/inside-browser-part-2"},{"text":"现代网络浏览器内幕 — 3","link":"/chrome/modern-web-browser/inside-browser-part-3"},{"text":"现代网络浏览器内幕 — 4","link":"/chrome/modern-web-browser/inside-browser-part-4"}],"collapsable":true},{"text":"性能","items":[{"text":"1. Welcome to Lean performance","link":"/chrome/performance/1-welcome"},{"text":"2. 一般 HTML 性能注意事项","link":"/chrome/performance/2-general-html-performance"},{"text":"使用导航定时和资源定时评估现场的负载性能","link":"/chrome/performance/navigation-and-resource-timing"},{"text":"优化长任务","link":"/chrome/performance/optimize-long-tasks"},{"text":"optimize-resource-loading 优化资源负载","link":"/chrome/performance/optimize-resource-loading"},{"text":"通过摇树减少 JavaScript 有效负载","link":"/chrome/performance/reduce-javascript-payloads-with-tree-shaking"},{"text":"asdf","link":"/chrome/performance/welcome-copy"},{"text":"速度为什么重要","link":"/chrome/performance/why-speed-matters"}],"collapsable":true},{"text":"性能技巧","items":[{"text":"Web 上的多进程：浏览器进程模型","link":"/chrome/performance/tips/browser-process-model"},{"text":"Browser Rendering Pipeline","link":"/chrome/performance/tips/browser-rendering-pipeline"},{"text":"通过火焰图找到有问题的代码","link":"/chrome/performance/tips/codepath-scoping"},{"text":"如何收集 Web 性能跟踪","link":"/chrome/performance/tips/collect-a-trace"},{"text":"事件循环基础知识","link":"/chrome/performance/tips/event-loop"},{"text":"深度讲解火焰图 🔥🔥","link":"/chrome/performance/tips/flamegraphs-in-depth"},{"text":"长任务：它们是什么以及为什么应该避免它们","link":"/chrome/performance/tips/long-tasks"},{"text":"performance 查看主线程（颜色含义）","link":"/chrome/performance/tips/main-profiler-pane"},{"text":"检测浏览器何时在 JavaScript 中绘制Frame","link":"/chrome/performance/tips/measuring-paint-time"},{"text":"如何阅读 Chromium Profiler","link":"/chrome/performance/tips/network-profiler-pane"},{"text":"使用 Chromium 网络标签页获取性能详情","link":"/chrome/performance/tips/network-tab"},{"text":"使用性能时序标记进行📏测量","link":"/chrome/performance/tips/performance-timing-markers"},{"text":"Chromium F12 性能分析器的基本概述","link":"/chrome/performance/tips/profiler-basic-ui"},{"text":"【--空文件--】: performance/tips/resource-size-vs-transfer-size.md","link":"/chrome/performance/tips/resource-size-vs-transfer-size"},{"text":"如何阅读火焰图 🔥","link":"/chrome/performance/tips/understanding-flamegraphs"},{"text":"识别 Web 应用中的未压缩资源","link":"/chrome/performance/tips/validating-compression"},{"text":"asdfadsasdsdfasdf","link":"/chrome/performance/tips/aa/a"}],"collapsable":true}],"design-pattern":[{"text":"Design-pattern","items":[{"text":"# 资源列表","link":"/design-pattern/indexs"},{"text":"代理模式","link":"/design-pattern/proxy-pattern"},{"text":"Singleton Pattern","link":"/design-pattern/singleton-pattern"},{"text":"状态模式","link":"/design-pattern/state-pattern"},{"text":"策略模式","link":"/design-pattern/strategy-pattern"}],"collapsable":true}],"open-source":[{"text":"Open-source","items":[{"text":"delay","link":"/open-source/delay"},{"text":"dot-prop","link":"/open-source/dot-prop"},{"text":"glob-to-regexp","link":"/open-source/glob-to-regexp"},{"text":"koa 洋葱模型","link":"/open-source/koa-compose"},{"text":"quick-lru","link":"/open-source/lru-cache"},{"text":"p-defer","link":"/open-source/p-defer"},{"text":"p-lazy","link":"/open-source/p-lazy"},{"text":"p-limit","link":"/open-source/p-limit"},{"text":"p-locate","link":"/open-source/p-locate"},{"text":"p-settle","link":"/open-source/p-settle"},{"text":"yocto-queue","link":"/open-source/yocto-queue"}],"collapsable":true}],"promise":[{"text":"Promise","items":[{"text":"顺序执行任务直到第一个resolved。","link":"/promise/first-resolved"},{"text":"reduce实现多个promise顺序执行.","link":"/promise/sequential-execution"}],"collapsable":true}],"typescript":[{"text":"Typescript","items":[{"text":"Typescript 技巧","link":"/typescript/tip"}],"collapsable":true}],"webpack":[{"text":"Webpack","items":[{"text":"webpack 打包代码分析","link":"/webpack/build-result"},{"text":"mini-webpack","link":"/webpack/mini-webpack"},{"text":"minipack-explain","link":"/webpack/minipack"},{"text":"tapable","link":"/webpack/tapable"}],"collapsable":true}]},"footer":{"message":"Released under the MIT License.","copyright":"Copyright © 2022-present Beka"}},"head":[["script",{"id":"check-dark-light"},"\n        ;(() => {\n          const saved = localStorage.getItem('island-theme-appearance')\n          const prefereDark = window.matchMedia('(prefers-color-scheme: dark)').matches\n          if (!saved || saved === 'auto' ? prefereDark : saved === 'dark') {\n            document.documentElement.classList.add('dark')\n          }\n        })()\n      "]],"base":"","icon":"","root":"/Users/beka/Desktop/code/bekacodechn.github.io/blog","appearance":true},"pagePath":"/Users/beka/Desktop/code/bekacodechn.github.io/blog/chrome/how-web-browser-works/part-3_rendering-phase.md","relativePagePath":"chrome/how-web-browser-works/part-3_rendering-phase.md","toc":[{"id":"from-document-to-web-page--8-sub-phases-从文档到网页--8-个子阶段","text":"From document to web page — 8 sub-phases 从文档到网页 — 8 个子阶段","depth":2},{"id":"phase-1-dom-construction-第-1-阶段dom-构建","text":"Phase 1: DOM construction 第 1 阶段：DOM 构建","depth":2},{"id":"phase-2-style-computation-第-2-阶段样式计算","text":"Phase 2: Style computation 第 2 阶段：样式计算","depth":2},{"id":"step-1-translating-css-第-1-步翻译css","text":"Step 1: “Translating” CSS 第 1 步：“翻译”CSS","depth":3},{"id":"step-2-standardizing-values-and-unites-步骤-2统一价值观和统一标准","text":"Step 2: standardizing values and unites 步骤 2：统一价值观和统一标准","depth":3},{"id":"step-3-style-computation-步骤-3样式计算","text":"Step 3: style computation 步骤 3：样式计算","depth":3},{"id":"phase-3-layout-布局","text":"Phase 3: Layout 布局","depth":2},{"id":"step-1-constructing-the-layout-tree-步骤-1构建布局树","text":"Step 1: constructing the layout tree 步骤 1：构建布局树","depth":3},{"id":"step-2-calculating-the-geometry-information-步骤-2计算几何体信息","text":"Step 2: calculating the geometry information 步骤 2：计算几何体信息","depth":3},{"id":"phase-4-layer-图层","text":"Phase 4: Layer 图层","depth":2},{"id":"具有堆叠上下文的元素","text":"具有堆叠上下文的元素","depth":3},{"id":"剪切元素","text":"剪切元素","depth":3},{"id":"phase-5-paint-绘制","text":"Phase 5: Paint 绘制","depth":2},{"id":"phase-6-tilling-耕作","text":"Phase 6: Tilling 耕作？？？","depth":2},{"id":"phase-7-raster-第7阶段光栅","text":"Phase 7: Raster 第7阶段：光栅","depth":2},{"id":"phase-8-draw-quad-and-display--第-8-阶段-绘制四边形并显示","text":"Phase 8: Draw Quad and Display  第 8 阶段： 绘制四边形并显示","depth":2},{"id":"what-is-the-takeaway-有什么启示","text":"What is the takeaway? 有什么启示？","depth":2},{"id":"2019-年渲染树不再重要","text":"2019 年，渲染树不再重要","depth":2},{"id":"references","text":"References","depth":2}],"title":"浏览器如何逐步工作 — 渲染阶段（第 3 部分）","lastUpdatedTime":"2023/11/9 01:52:20","content":"# 浏览器如何逐步工作 — 渲染阶段（第 3 部分）\n\n\n`metadata:`\n\n**原标题:** How does browser work step by step [latest] — rendering phase (part 3)\n\n**链接:** https://cabulous.medium.com/how-does-browser-work-in-2019-part-iii-rendering-phase-i-850c8935958f\n\n---\n\n![20231108180639](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108180639.png)\n\n在上一篇文章中，我们看到了导航阶段。三个流程协同工作，为下一阶段交付文档。\n\n在这篇文章中，我们将打开渲染阶段的盒子，看看里面有什么。\n\n## From document to web page — 8 sub-phases 从文档到网页 — 8 个子阶段\n\n![20231108180816](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108180816.png)\n\n渲染阶段包括 8 个子阶段：\n\n1.  DOM construction **DOM 构造**\n2.  Style computation 样式计算\n3.  Layout 布局\n4.  Layer 层\n5.  Paint 绘制\n6.  Tilling 耕作\n7.  Raster 网 格\n8.  Draw Quad and display 绘制四边形并显示\n\n渲染器进程中的两个线程涉及：\n\n- 主线程负责 1-5 个阶段\n- 合成器线程管理 6-8 个阶段\n\n![20231108181205](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108181205.png)\n\n## Phase 1: DOM construction 第 1 阶段：DOM 构建\n\n![20231108181234](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108181234.png)\n\n输入是网络进程中的 HTML 文档，输出是 DOM 树。\n\n为什么要使用 DOM 树？浏览器不会说 HTML。渲染过程首先需要将 HTML 文档 \"翻译 \"成浏览器可以理解的内容。\n\n这就是 DOM 树。\n\n让我们看一个例子。\n\n```html\n<html>\n<body>\n   <h1>Hello world!</h1>\n   <div>\n       <p>\n           It is a message from\n           <span>the web</span>\n       </p>\n   </div>\n</body>\n</html>\n```\n\n![20231108181419](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108181419.png)\n\n该示例的DOM树如图所示。\n\nDOM 树是 HTML 代码的表示形式。我们可以通过在 Chrome 浏览器控制台中输入 \"document \"来访问它。\n\nDOM 树存在于内存中。因此，JavaScript 可以访问和编辑它。\n\n## Phase 2: Style computation 第 2 阶段：样式计算\n\n![20231108181607](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108181607.png)\n\n输入是 CSS 样式，输出是计算后的样式结构。\n\n它有三个步骤。\n\n### Step 1: “Translating” CSS 第 1 步：“翻译”CSS\n\n与 HTML 相似，浏览器不会说 CSS。翻译的结果就是样式表。\n\n在 Chrome 浏览器控制台中输入 \"document.styleSheets\"，我们就能看到所有已解析的样式表。\n\n这些样式表来自\n\n- a source linked in the <link> tag, (在 `<link>` 标记中链接的源代码、)\n- styles inside of a <style>, and (内的样式，以及)\n- inline styles (内联样式)\n\n与 DOM 树一样，样式表看起来像 JavaScript 对象结构，可以在内存中访问和编辑。\n\n![20231108182010](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108182010.png)\n\n以 Medium 主页为例。它有 11 个样式表。第一个来自 `<link>` 标签，其余的都是 `<style>` 标签内的样式。\n\n### Step 2: standardizing values and unites 步骤 2：统一价值观和统一标准\n\n我们在 CSS 中使用各种数值和单位。\n\n- 宽度： 50%\n- padding：2em 0\n- font-size: 1rem\n\n它们是相对值。\n\n在这一步，所有相对值都会转换为绝对值，即像素。\n\n为什么是像素？在渲染阶段结束时，浏览器会在屏幕上显示位图。位图由像素组成。\n\n现在是计算的时候了。\n\n在标准化结束时，先前的 CSS 值将变为以下值：\n\n- width: 500px（假设其父元素的宽度为 1000px。）\n- padding：32px 0（假设元素的字体大小为 16px。）\n- font-size: 16px（假设根元素的字体大小为 16px。）\n\n### Step 3: style computation 步骤 3：样式计算\n\n![20231108182642](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108182642.png)\n\n最后，渲染器程序会计算所计算的样式，并将其附加到每个元素上。\n\n为什么要计算样式？CSS 是层叠样式表的缩写。层叠是指元素从其祖先那里继承一些样式，并用自己的样式覆盖其中的一部分。\n\n渲染器程序会根据层叠规则计算所有样式。然后，它会为每个元素生成一个最终计算样式的列表。\n\n例如，一个元素从其祖先那里继承了 font-size: 16px。其自身的字体大小为 32px。计算出的字体大小样式就是 font-size: 32px。\n\n![20231108182859](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108182859.png)\n\n图片显示的是 Medium 主页上 h2 元素的计算样式列表。\n\n计算完成后，最终结果是一个计算样式列表。我们可以在 Chrome 浏览器控制台中查看。\n\n## Phase 3: Layout 布局\n\n![20231108183005](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108183005.png)\n\n在此阶段，输入是 DOM 树和计算出的样式。输出则是包含计算布局信息的布局树。\n\n### Step 1: constructing the layout tree 步骤 1：构建布局树\n\n布局树看起来就像 DOM 树的复制品。\n\n有哪些不同之处呢？首先，DOM 树中的 \"不可见 \"元素不会包含在布局树中。\n\n例如，布局树中不会包含 display: none 的元素。这与 `<header>` 标签内的所有元素一样。但有一个例外：在布局树中包含 visibility: hidden; 的元素。\n\n其次，某些 CSS 属性会将内容添加到布局中。\n\n以伪类为例，`div::after {content：'我在这里';}`会创建一个包含在布局树中的内容，尽管它并不存在于 DOM 树中。\n\n### Step 2: calculating the geometry information 步骤 2：计算几何体信息\n\n要在空白的画布上画出一个盒子，我们需要知道：\n\n- 起始 x、y 坐标，以及\n- 方框的大小\n\n布局树中的每个元素都是一个方框。\n\n计算每个元素的最终几何形状是一项艰巨的工作。想一想吧。在 CSS 中，有许多属性可以修改元素的几何形状。\n\n- float: left；\n- 宽度： 100px；\n- display: absolute；\n- 以及更多...\n\n要设计一个有效的布局系统与之配合使用，是一项具有挑战性的工作。[BlinkOn 的开发人员与我们分享了一些知识](https://www.youtube.com/watch?v=Y5Xa4H2wtVA)，如果你感兴趣的话。\n\n主线程为我们完成了繁重的工作，并完成了所有计算。\n\n现在，它有了一个布局树。在布局树上，每个元素都有精确的坐标和尺寸信息。\n\n## Phase 4: Layer 图层\n\n![20231108184128](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108184128.png)\n\n输入是布局树，输出是图层树。\n\n第三层是关于层的。\n\n我们都喜欢 CSS 中的 3D 变换效果和方便的 `z-index` 属性。它们都与层有关。\n\n如果你用过 Photoshop 或 Sketch，你一定会对图层很熟悉。浏览器中的层也有同样的概念。\n\n而图层树则与绘制顺序有关。我们为什么要关心绘制顺序？\n\n例如，有两个重叠的元素，元素 A 和元素 B。A 的 `z-index`是 9，比没有 z-index 属性的 B 更重要。渲染器会先在画布上绘制 B，然后再在其上绘制 A。这是一种绘制顺序。\n\n绘制顺序对于准确显示网页至关重要。\n\n图层树是怎样的？\n\n![20231108184419](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108184419.png)\n\n**从图中我们可以看到，并非所有元素都有自己的图层。绘制图层的成本很高。为了提高性能，渲染器进程只在需要时才创建图层。**\n\n何时需要？渲染器进程会考虑两种元素。\n\n### 具有堆叠上下文的元素\n\n*   z-index\n*   position: absolute\n*   transform\n*   will-change\n\n以上是一些与堆叠上下文相关的 CSS 属性。渲染器处理过程会为具有这些属性的元素创建一个层。\n\n你可以在 [MDN 文档](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context)中查看影响层树的 CSS 属性的完整列表。\n\nChrome 浏览器允许我们查看网页上的层。\n\n### 剪切元素\n\n溢出文本元素是剪切元素的典型案例。\n\n假设我们有一个 300px * 300px 的 div。div 框中的长文本会溢出。在给方框设置 `overflow: auto;` 时，我们知道文字在 div 中可以滚动。\n\n当看到溢出的文本元素时，渲染器会创建三个层。\n\n- 一个用于剪切文本，在 300px * 300px 区域内可见。\n- 一个用于显示全文内容，以便滚动浏览。\n- 一个用于滚动条\n\n在控制台中查看更容易理解这种机制。\n\n在 Chrome 浏览器中运行以下 HTML。\n\n```html\n<html>\n<body>\n    <h1>Hell world!</h1>\n    <div class=“box” style=“width: 300px; height: 300px; overflow: auto;”>\n        <p>Lorem ipsum vel viverra elementum ut et parturient placerat curae at vestibulum ullamcorper a ullamcorper mattis nascetur ullamcorper ut mollis rhoncus sed parturient in vestibulum vestibulum. Leo nec nisi nec erat a purus aliquam habitasse a sem id nisi ullamcorper viverra suspendisse mollis fringilla a dis a suspendisse parturient a. A commodo scelerisque mi dictum non orci suspendisse felis velit dapibus a sit facilisis velit mi libero ultrices leo consectetur tempus montes quis consequat condimentum a ullamcorper amet. Donec orci fames id consectetur nascetur parturient et magnis nunc lacinia aliquet nec dolor dictumst conubia a hac nibh consectetur habitant vel a cras.</p>\n</div>\n</body>\n</html>\n```\n\n打开图层面板看一看。图层显示在图层面板中。尝试滚动框中的文字，你就会明白了。\n\n![20231108185209](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108185209.png)\n\n但实践中，只有 1. 一个用于显示全文内容，以便滚动浏览。  2. 一个用于滚动条。 左侧列表也只有3个item，比文中给出的示例少一个。\n![20231108190307](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108190307.png)\n\n最后，在完成所有计算后，渲染器进程就可以得到图层树了。\n\n## Phase 5: Paint 绘制\n\n![20231108190755](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108190755.png)\n\n在这一阶段，输入是布局树和图层树，输出是 paint record.\n\npaint record 是什么样的？\n\n它由三部分组成：\n\n*   Action\n*   Position, including the coordinates (x, y) and the size (width, height). 位置，包括坐标（x、y）和尺寸（宽、高）。\n*   Styles\n\nFor example, a paint record looks like the following:\n\n*   Action: Draw Rect\n*   Pos: 0, 0, 300, 300\n*   backgroundColor: red\n\n这是一条在（0，0）处绘制 300px * 300px 红色矩形的绘画记录。\n\n绘制记录就像浏览器执行绘制的注释。\n\n绘画记录是这些注释的列表，按照我们在图层树中确认的顺序排列，比如 \"先背景，后矩形，再文本\"。\n\n在下一步中，合成器线程将继承主线程的工作，开始根据绘画记录生成位图。\n\n## Phase 6: Tilling 耕作？？？\n\n![20231108192332](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108192332.png)\n\n平铺时，图层被分成图块，浏览器根据视口位置优先渲染。\n\n这里有三个关键字：图层、图块和视口。\n\n让我们以 Medium 主页为例。从 DevTools 的图层面板中，我们可以看到它有三个图层：\n\n*   document\n*   header\n*   scroll bar\n\n![20231108192510](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108192510.png)\n\n“文档”层被分成图块。通常，图块大小为256px*256px或512px*512px。\n\n![20231108192638](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108192638.png)\n\n渲染所有图块都很昂贵。当前在视口中的可见图块具有优先级。\n\n## Phase 7: Raster 第7阶段：光栅\n\n![20231108192718](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108192718.png)\n\n输入是图块，输出是位图。\n\n了解图块后，合成器线程创建一个光栅线程池。多个光栅线程同时进行光栅图块。\n\n![20231108192825](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108192825.png)\n\n为了加快进程，光栅线程通过 IPC 向 GPU 进程发送图块。然后，GPU 进程根据图块生成位图，并将位图保存在 GPU 内存中。\n\n位图准备就绪后，GPU 进程会将其传送回渲染进程中的合成线程，以便进行下一步处理。\n\n## Phase 8: Draw Quad and Display  第 8 阶段： 绘制四边形并显示\n\n![20231108193018](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108193018.png)\n\n输入是位图，输出是合成帧。\n\n当所有需要的位图都处理完毕后，合成器线程会向浏览器进程发送一条名为 \"绘制四边形 \"的命令。\n\n在浏览器进程内部，“viz”组件接收Draw Quad命令，执行Display Compositor命令，并将合成器帧“绘制”到我们的计算机内存中。\n\n![20231108193213](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108193213.png)\n\n最后，浏览器进程在浏览器中显示合成器帧(compositor frame)。\n\n令人印象深刻的是，在现代浏览器中，整个8个阶段都在1/60秒内发生。也就是16.67毫秒。\n\n## What is the takeaway? 有什么启示？\n\n![20231108193347](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231108193347.png)\n\n渲染的8个阶段：\n\n1.  The main thread in the renderer process “translates” the HTML document to **DOM tree**\n2.  It conveys(传送) CSS into the **computed style**\n3.  It creates a **layout tree** based on the DOM tree and computed style\n4.  From a layout tree, it generates a **layer tree**\n5.  Lastly, it establishes **paint records**\n6.  The compositor thread(合成线程) carries over the paint records, starts **tilling** based on the current viewport\n7.  Multiple raster threads **raster** tiles into bitmaps with the help of the GPU process.\n8.  The browser process receives the **Draw Quad** command from the browser process, then it displays a frame of the page in front of us.\n\n## 2019 年，渲染树不再重要\n\n如果你听说过 \"渲染树\"，那么它在 2019 年已不再适用。类似的概念还有图层树。\n\n:::danger\n原文：\n\n## Render tree is not relevant in 2019\n\nIf you heard of render tree, it is not relevant anymore in 2019. A similar concept here is the layer tree.\n\n为什么说不适用？\n:::\n\n\n## References\n\n*   [Inside look at modern web browser (part 3) | Google Developers](https://developers.google.com/web/updates/2018/09/inside-browser-part3)\n*   [Understanding CSS z-index — CSS: Cascading Style Sheets | MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index)\n","pageType":"doc","routePath":"/chrome/how-web-browser-works/part-3_rendering-phase"};</script>
      
      <script type="module" src="/client-entry.js"></script>
    </body>
  </html>