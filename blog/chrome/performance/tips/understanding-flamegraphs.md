# å¦‚ä½•é˜…è¯»ç«ç„°å›¾ ğŸ”¥

`metadata:`

**åŸæ ‡é¢˜:** How to Read Flamegraphs ğŸ”¥

**é“¾æ¥:** https://webperf.tips/tip/understanding-flamegraphs/

---

ç«ç„°å›¾æ˜¯ç›´è§‚åœ°è¡¨ç¤ºè¿è¡Œæ—¶ä»£ç å †æ ˆè·Ÿè¸ªåŠå…¶å„è‡ªä½œä¸ºå±‚æ¬¡ç»“æ„æ‰§è¡Œçš„æ—¶é—´çš„è¡Œä¸šæ ‡å‡†æ–¹æ³•ã€‚

è¿™äº›å›¾å½¢æ—¨åœ¨å¸®åŠ©å·¥ç¨‹å¸ˆå¿«é€Ÿè¯†åˆ«ç“¶é¢ˆå¹¶é¢‘ç¹è¿è¡Œä»£ç è·¯å¾„ã€‚

ä»¥ä¸‹æ˜¯ Chromium Profiler ç”Ÿæˆçš„ç«ç„°å›¾ç¤ºä¾‹ï¼š

![20231110160858](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231110160858.png)

## A Simple Example

è¯·è€ƒè™‘ä»¥ä¸‹åŠŸèƒ½ï¼š

```js
function c() {
    // Do something for 50ms
    const start = Date.now();
    while (Date.now() - start < 50) {
        /* block the thread */
    }
}

function b() {
    c();
}

function a() {
    b();
}

a();
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒÂ `function a()`Â è°ƒç”¨Â `function b()`Â å’ŒÂ `function b()`Â è°ƒç”¨Â `function c()`Â ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒÂ `function c()`Â éœ€è¦ 50 æ¯«ç§’æ‰èƒ½å®Œæˆã€‚

ä¸ºäº†å°†æ­¤è°ƒç”¨å †æ ˆè¡¨ç¤ºä¸ºç«ç„°å›¾ï¼Œæˆ‘ä»¬å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

![20231110161609](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231110161609.png)

## More complex examplesÂ æ›´å¤æ‚çš„ç¤ºä¾‹

è®©æˆ‘ä»¬è°ƒæ•´Â `function b()`Â ä¸ºè°ƒç”¨Â `function c()`Â 3 æ¬¡ï¼Œè€Œä¸æ˜¯åªè°ƒç”¨ä¸€æ¬¡ã€‚

```js
function c() {
    // Do something for 50ms
    const start = Date.now();
    while (Date.now() - start < 50) {
        /* block the thread */
    }
}

function b() {
    c();
    c();
    c();
}

function a() {
    b();
}

a();
```

è¿™å°†å¯åŠ¨ 3 æ¬¡Â `function c()`Â è°ƒç”¨ï¼Œæ¯æ¬¡è°ƒç”¨éœ€è¦ 50 æ¯«ç§’ã€‚

ç”Ÿæˆçš„ç«ç„°å›¾å°†å¦‚ä¸‹æ‰€ç¤ºï¼š

![20231110162006](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231110162006.png)

è¯·æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

*   `function c()`Â ç”¨ 3 ä¸ªç‹¬ç«‹çš„ 50ms å—è¡¨ç¤ºï¼Œæ¯ä¸ªå—æœ‰ 50ms çš„ç´¯ç§¯æ—¶é—´ã€‚
*   `function b()`Â è¡¨ç¤ºä¸º 1ä¸ª 150ms å—ï¼Œå› æ­¤å…¶ç´¯è®¡æ—¶é—´ä¸º 150msã€‚
*   `function a()`Â è¡¨ç¤ºä¸º 1ä¸ª 150ms å—ï¼Œå› æ­¤å…¶ç´¯è®¡æ—¶é—´ä¸º 150msã€‚

:::warning
ä½†å®æµ‹å•ä¸ª`c`çš„`50ms`è¢«åˆ†æˆäº†å¤šä¸ªå—ï¼Œæ¯ä¸ªä¸è¶³`50ms`ï¼Œæ€»å…±å¤šä¸ª3ä¸ªï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ
:::

![20231110162327](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231110162327.png)


è®©æˆ‘ä»¬å†è¿›è¡Œä¸€æ¬¡è°ƒæ•´å¹¶ç”Ÿæˆå¦ä¸€ä¸ªç«ç„°å›¾ï¼Œè¿™æ¬¡æ˜¯Â `function a()`Â .

```js
function c() {
    // Do something for 50ms
    const start = Date.now();
    while (Date.now() - start < 50) {
        /* block the thread */
    }
}

function b() {
    c();
    c();
    c();
}

function a() {
    b();
    b();
}

a();
```
ç°åœ¨ï¼ŒÂ `function a()`Â è°ƒç”¨Â `function b()`Â ä¸¤æ¬¡ã€‚

ç”Ÿæˆçš„ç«ç„°å›¾å°†å¦‚ä¸‹æ‰€ç¤ºï¼š

![20231110162602](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231110162602.png)

è¯·æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

*   `function c()`Â ä»¥ 6 ä¸ªç‹¬ç«‹çš„ 50ms å—è¡¨ç¤ºï¼Œæ¯ä¸ªå—æœ‰ 50ms çš„ç´¯ç§¯æ—¶é—´ã€‚
*   `function b()`Â è¡¨ç¤ºä¸º2ä¸ª150mså—ï¼Œæ¯ä¸ªå—çš„ç´¯è®¡æ—¶é—´ä¸º150msã€‚
*   `function a()`Â è¡¨ç¤ºä¸º 1 300ms å—ï¼Œå› æ­¤å…¶ç´¯è®¡æ—¶é—´ä¸º 300msã€‚

å®é™…è¿è¡Œå›¾ï¼š
![20231110162811](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231110162811.png)

## Traditional Flamegraphs vs. Chromium Profiler Icicle Graphs  (ä¼ ç»Ÿç«ç„°å›¾ä¸ Chromium Profiler å†°æŸ±å›¾)

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘åœ¨ç¤ºä¾‹ä¸­å±•ç¤ºçš„ç«ç„°å›¾æ˜¯ä¼ ç»Ÿçš„ç«ç„°å›¾ã€‚è®¸å¤šæ€§èƒ½æ¢æŸ¥å™¨å°†ç”Ÿæˆä¸æˆ‘æ‰€å±•ç¤ºçš„å®Œå…¨ç›¸åŒçš„å›¾å½¢ã€‚

ä½†æ˜¯ï¼ŒChromium F12 æ€§èƒ½åˆ†æå™¨ä¼šç”Ÿæˆä¼ ç»Ÿç«ç„°å›¾çš„å˜ä½“ï¼Œç§°ä¸º**å†°æŸ±å›¾**ã€‚

å†°æŸ±å›¾æ˜¾ç¤ºçš„æ•°æ®ä¸ç«ç„°å›¾å®Œå…¨ç›¸åŒï¼Œåªæ˜¯ç¿»è½¬äº† y è½´æ–¹å‘ã€‚

ä¾‹å¦‚ï¼Œåœ¨æœ€åä¸€ä¸ªç¤ºä¾‹ä¸­ï¼ŒChromium F12 æ€§èƒ½åˆ†æå™¨å†°æŸ±å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![20231110162906](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231110162906.png)

## Looking at a real graph (çœ‹ä¸€ä¸ªçœŸå®çš„å›¾è¡¨)

æˆ‘æ•è·äº†æˆ‘ä»¬å¼•ç”¨çš„ç¤ºä¾‹ä»£ç çš„ Chromium æ€§èƒ½é…ç½®æ–‡ä»¶ï¼Œè¿™å°±æ˜¯ç”Ÿæˆçš„å†°æŸ±å›¾ï¼

![20231110163015](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231110163015.png)

è¯·æ³¨æ„ï¼Œç”±äºåˆ†æå™¨åœ¨è¿è¡Œæ—¶è·Ÿè¸ªæµè§ˆå™¨æ—¶æ”¶é›†æ•°æ®çš„æ–¹å¼ï¼Œå› æ­¤åœ¨â€œä¸»â€çª—æ ¼ä¸­çœ‹ä¸åˆ° 50 æ¯«ç§’çš„Â `function c()`Â å—å’ŒÂ `function b()`Â è°ƒç”¨ã€‚å› æ­¤æ·»åŠ [è‡ªå®šä¹‰æ€§èƒ½è®¡æ—¶æ ‡è®°](./performance-timing-markers.md)å¯ä»¥å°†åˆ†æå™¨æ”¶é›†çš„å†…å®¹ä¸â€œè®¡æ—¶â€çª—æ ¼ä¸­æ•è·çš„æ›´ç²¾ç¡®çš„è‡ªå®šä¹‰æ ‡è®°è¿›è¡Œæ¯”è¾ƒã€‚

```js{1,3,20}
    let i = 0;
    function c() {
      performance.mark(`c() called ${i++}`)
      // Do something for 50ms
      const start = Date.now();
      while (Date.now() - start < 50) {
        /* block the thread */
      }
    }

    function b() {
      c();
      c();
      c();
    }

    function a() {
      b();
      b();
      performance.mark('c() called end')
    }

    a();
```
å®æµ‹å›¾ï¼š

![20231110164309](https://blog-1318409910.cos.ap-beijing.myqcloud.com/blog/20231110164309.png)

è¿™é‡ŒçœŸæ­£é‡è¦çš„æ˜¯ï¼Œæ‚¨å¯ä»¥æ£€æŸ¥è°ƒç”¨å †æ ˆä¸­æ¯ä¸ªå‡½æ•°çš„ç´¯ç§¯æ—¶é—´ï¼Œå¹¶æŸ¥çœ‹å“ªäº›å‡½æ•°è°ƒç”¨åŠ èµ·æ¥è¾¾åˆ° 302.42 æ¯«ç§’çš„ç´¯ç§¯æ—¶é—´ã€‚

ä»ä¸»çª—æ ¼ä¸­æ•è·çš„å›¾å½¢ä¸­å¯ä»¥æ¸…æ¥šåœ°çœ‹å‡ºä»€ä¹ˆï¼š

*   æœ‰ä¸€ä¸ª JavaScript æ‰§è¡Œä»»åŠ¡ï¼Œç´¯è®¡æ—¶é—´ä¸º 302.42ms
*   æ­¤ä»»åŠ¡å…·æœ‰ç›¸å½“çŸ­çš„è°ƒç”¨å †æ ˆï¼ˆ4 ä¸ªå †æ ˆå¸§ï¼‰ï¼šÂ `(anonymous)`Â ã€ã€Â `a`Â å’ŒÂ `b`Â `c`
*   å †æ ˆå¸§Â `c`Â ä»¥é«˜é¢‘ç‡è°ƒç”¨ï¼Œå¹¶ä¸”æ˜¯ JavaScript ä»»åŠ¡ 302.42ms ç´¯ç§¯æ—¶é—´çš„å”¯ä¸€è´¡çŒ®è€…ã€‚

## Conclusion

æ‚¨ç°åœ¨äº†è§£å¹¶å¯ä»¥é˜…è¯»åŸºæœ¬çš„ç«ç„°å›¾ï¼

è€ƒè™‘[æ·±å…¥ç«ç„°å›¾æç¤º](https://webperf.tips/tip/flamegraphs-in-depth)ï¼Œä»¥é˜…è¯»æ›´å¤šé«˜çº§ç«ç„°å›¾ï¼
